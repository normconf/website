
<!DOCTYPE html>
<html>

<head>
  <title>Normconf: How small can I get that Docker container? - Matthijs Brouns Transcript</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description"
    content="Transcript of How small can I get that Docker container? - Matthijs Brouns from Normconf" />
  <meta property="og:title" content="Normconf: How small can I get that Docker container? - Matthijs Brouns Transcript" />
  <meta property="og:url" content="https://normconf.com" />
  <meta name="og:description"
    content="Transcript of How small can I get that Docker container? - Matthijs Brouns from Normconf" />
  <meta property="og:image" content="https://normconf.com/images/normconf_banner_metadata_1000x500.png" />
  <meta property="og:type" content="website" />
  <meta name="twitter:image" content="https://normconf.com/images/normconf_banner_metadata_1000x500.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="normconf.com" />
  <meta name="twitter:creator" content="@normconf" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link href="fontawesome/css/all.min.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="images/favicon.ico">
  <style>
    body {
      background-image: url('images/background_placeholder.png');
    }

    .hero {
      background-color: None;
      color: #797979;
      font-family: sans-serif;
    }

    .center {
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 50%;
    }

    a:link {
      color: #4200be;
    }

    a:visited {
      color: #4200be;
    }

    a:active {
      color: #ef028c;
    }

    a:hover {
      color: #ef028c;
    }

    a.light_link:link {
      color: #ef028c;
    }

    a.light_link:visited {
      color: #4200be;
    }

    a.dark_link:link {
      color: #ef028c;
    }

    a.dark_link:visited {
      color: #ef028c;
    }

    a.dark_link:active {
      color: #5fffcf;
    }

    a.dark_link:hover {
      color: #5fffcf;
    }

    a.on_pink:link {
      color: #5fffcf;
    }

    a.on_pink:active {
      color: #6017af;
    }

    a.on_pink:hover {
      color: #4200be;
    }

    .navbar.is-dark .navbar-end>a.navbar-item:hover {
      background-color: #ef028c;
    }

    .navbar.is-dark .navbar-item {
      white-space: normal;
    }

    .navbar.is-dark .navbar-item.has-dropdown:hover .navbar-link {
      background-color: #ef028c;
    }

    .navbar.is-dark .navbar-brand>a.navbar-item:hover {
      background-color: #6017af;
    }

    .button.is-danger {
      background-color: #ef028c;
    }

    .button.is-primary {
      background-color: #5fffcf;
      color: #4200be;
    }

    table.speakers1 {
      font-weight: bold;
      color: #4200be;
      width: auto;
    }

    table.speakers2 {
      font-weight: bold;
      color: #6017af;
      width: auto;
    }

    table.schedule {
      font-weight: bold;
      /* width: auto; */
    }

    table.schedule td {
      text-align: center;
      padding: 0.5em;
      max-width: 30em;
      /* word-wrap: break-word; */
    }

    table.schedule tr:nth-child(odd) {
      color: #4200be;
      background-color: #00000017;
    }

    table.schedule tr:nth-child(even) {
      color: #6017af;
    }

    .message.is-primary .message-header {
      background-color: #5fffcf;
      color: #4200be;
    }
  </style>
  </head>
  <body>
  <section class="section" style="background-color: #6017af;">
    <div class="container">
    <div class="box">
      <h1 class="title">
        How small can I get that Docker container? - Matthijs Brouns
      </h1>
      <p class="subtitle">
        Transcript generated with <a href='https://github.com/openai/whisper'>OpenAI Whisper</a> <code>large-v2</code>.
      </p>
      </div>
      <div class="box">
        <a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=0">So my name is Matthijs. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1">I work at Accelerator where I give trainings. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=4">I give a lot of trainings on data and DevOps related things in my work time. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=9">In my spare time, I really like to dig into things and see how they work and what makes </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=13">them tick. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=14">Docker is definitely one of them. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=17">What I'll do today is I'll share a story with you that's based on some experience from like </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=21">seven, eight years ago when I was doing my first ML project that actually had to go to </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=26">production. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=29">We recently started using Docker for some Django services, some Flask services. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=34">We had them running on VMs and Docker seemed like a good bet to get this machine learning </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=39">project in production as well. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=41">So I got some help from some people and I whipped up the first Docker file. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=47">And the simplest Docker file that you could probably build to do this looked something </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=52">like this. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=53">I mean, for go to version numbers, they're a bit more recent than seven years ago, of </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=57">course. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=58">So we just grab a decent base image, Python three, eight. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=62">We copy in some requirements files, we install them, we copy the rest of our source code </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=66">and like maybe we run some tests or we start an application when we actually are starting </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=70">up. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=73">Because this was a data science problem, this was a container that trained a model or dependencies </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=77">look something like this. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=79">We had, you know, second learn and pandas to do the actual ML part and the data wrangling </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=84">parts of course use NumPy as well and SciPy in the background. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=89">Thing produced some plots so we needed not plotlib to make sure that we could actually </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=92">get some nice statistics out of this thing as well. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=96">So you know, I, this together with the code of the actual model made a nice commit out </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=102">of this, submitted it, asked for a review. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=106">And this is the answer that I got. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=110">This container is massive. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=112">There's all this stuff in there that you don't need. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=115">We can't actually run this thing as it is now. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=118">Yeah, whoops, that kind of makes sense. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=123">And at this point you also maybe understand why Docker chose like a massive mammal as </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=128">their logo because this thing is 1.7 gigabytes for just a simple Python container. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=134">It's insane. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=135">And if we go back to the Docker phone, we think about that thing again and it's kind </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=140">of obvious also why it's so big. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=144">There was this line in there that said copy dot dot and it just grabs our entire project </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=149">folder and yanks it into the container without really deciding whether that's needed or not. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=155">And you know, I don't know about you, but a typical project folder for me looks something </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=160">like this. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=161">There's a git folder that stores my git repository. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=165">There's an IDE folder which has like my settings for my development environment. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=170">Maybe there's some local data, some locally trained models, some notebooks that I'm using. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=175">There's a virtual env in there that I'm using to test things and install things. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=179">And all this stuff got copied into my container. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=183">And a lot of this is actually not needed. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=186">So what should we do here? </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=189">Well, we're not going to sort of one by one type out everything that we do need to add. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=194">But what we do is we add like a Docker ignore file to our repo as well. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=199">This thing works the same as a git ignore. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=202">Essentially it tells Docker in this case, don't copy all these files when you're copying </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=207">into your container image. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=210">I typically also use essentially the same thing that I use for my git ignore, except </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=214">that I also add the git folder to the Docker ignore because there's no need for git history </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=218">in there as well. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=222">And when I rebuilt this container, it already started to make a bit more sense, but it was </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=225">still massive. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=226">You know, 1.3 gigabytes, it's not as bad. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=231">So I committed this, asked for another review. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=234">And that's also the feedback that I got. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=236">You know, it's much better, but still a bit on the big side. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=239">So let's try to shave off a bit more. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=242">Let's use a smaller base image. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=245">Because if you look at the Docker history of this container that we just built, essentially </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=250">almost a gigabyte of this size came from this Python 3.8 base image. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=257">So step two in this journey was using a different base image. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=261">And that was very, very straightforward because there's a slim version of Python, Python 3.8 </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=267">slim or 3.9 slim, which is based on a different Debian image, Debian buster slim, which doesn't </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=274">install manual pages and other useful packages that you use on like a normal Debian operating </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=282">system install, but not in a non-interactive environment like a container. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=288">So I rebuilt this thing and at this point I kind of started enjoying myself. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=294">This dropped down to 490 megabytes. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=296">That's quite a big, big difference. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=299">That's pretty cool. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=300">So I went back to our operations and said, you know, this is fun. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=306">This is triggering something in me. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=307">This number going down is brilliant. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=309">So what should I do next? </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=312">How can I figure out, what can I still do? </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=316">And they said, you know, there's this tool called Dive. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=319">Dive is pretty cool. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=320">It allows you to look at your container image that you've built and sort of see what's in </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=324">there. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=325">So now at this point I thought, this sounds fun. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=329">This is a couple of evenings of just digging around and trying things. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=333">Let's dive in. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=335">So this is what Dive looks like. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=337">It's a terminal user interface. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=340">You run Dive with an image name and then you get this after some analysis time. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=343">And what we see here on the top left, sort of this area is essentially all the layers </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=349">that our Docker image contains. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=352">You can scroll through them. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=353">And then on the right side, you see the files that are the state of the file system at that </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=358">point in time for that layer. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=362">Everything in orange is adjusted. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=363">Everything in green is new. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=366">So we can sort of see what this layer added. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=370">And one of the first things that I noticed was that there is an 80 megabytes cache folder. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=377">That seems kind of weird. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=381">Also in Matplotlib, there's some tests. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=383">All these tests have baseline images. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=386">There's also a couple of megabytes. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=388">Then if you dig further, you'll see there's markdown files and there's txt files and there's </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=393">like pyx files. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=395">All of those things are useful in the context of interactive development, but kind of useless </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=400">for this production container image setting. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=404">So I thought, let's just try to get rid of them. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=409">So I adjusted my Docker file slightly again, and I added a couple of statements near the </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=414">end to say, well, get rid of this pip cache. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=417">Look in this site packages folder and find everything that ends with like JPEG or JavaScript </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=422">maps or uncompiled C source code. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=426">Just get rid of it. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=428">That should save at least the 80 megabytes of our pip cache, but probably even more. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=436">Now when I actually tried to build this, I kind of got surprised because in contrast </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=441">to what I believe, this actually made our image bigger rather than smaller. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=446">It added like 14 megabytes for some reason. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=450">I tried to look around for a bit, but I didn't really understand why this was happening. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=455">So back to our operations person again, what's actually going on here? </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=460">Do you understand this? </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=461">And he pointed me in the right direction and said, you should read up on how these layers </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=467">of container images work. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=469">Okay, all right, that sounds doable. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=472">How do they work? </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=474">Essentially when you build a container image, every run statement in your Docker file becomes </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=479">a new layer. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=481">And a layer is the difference in file system content of what happened after the layer versus </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=487">what was there before. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=489">So if you have a layer that adds a requirements.txt, essentially that layer will have a zipped </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=496">tar file that has that requirements.txt there in that right location. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=503">Requirements.txt is not that big, it's like 85 bytes, just that is that layer that's part </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=509">of our image. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=511">Same thing will happen when we go pip install, this pip install will run, Docker will check </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=515">what is the difference after running pip install versus before. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=519">Let's take that difference, put it in a tar, that's our new layer as well. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=526">Now the thing that becomes interesting when we start to remove things, because a layer </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=532">can't go back to previous layers and change things in them. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=536">So the only thing that we can do in that layer where we say, delete the cache pip folder </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=542">is essentially make a tombstone. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=545">Say that there was a file here, but it's not anymore. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=549">From this point on, you should consider it as if it doesn't exist. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=552">It's essentially a zero bytes layer that says this file that was previously there, treated </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=557">as if it's not there anymore. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=561">And the same thing happens of course for this find thing. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=568">This is also why there is no actual size decrease when we structure our container image like </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=574">we did. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=575">So after giving this some thought, the answer was kind of obvious. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=580">We need to make sure that we add files and delete files in the same layer. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=587">And we can simply do that by chaining some bash commands together. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=591">So when I do a pip install, also on the same line, but part of the same run statement, </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=597">run this find command with the delete and instruct pip. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=602">Pip has an option that says no cache there, so it can actually not even make that pip </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=607">cache in the first place. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=612">And essentially squashing these layers together, that did work. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=616">That was quite a big step. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=621">One side note, we can do this manually like this, so just combining this adding and deletion </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=626">in the same run statement. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=627">There is also a squash command when you do a Docker build that kind of does this for </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=632">you, but it just does this for all the layers. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=634">Which makes it slightly smaller and slightly less work to do, but has some disadvantages </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=640">with layer caching. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=642">Yeah, slightly less optimal now. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=647">So at this point, we shaved more than a gigabyte of our initial image and almost a gigabyte </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=653">off the image with the Docker ignore. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=655">So it was going in the right direction. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=658">And I started Googling a bit and I got some hints that said, well, maybe you should try </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=662">looking at Alpine. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=664">Python free Alpine is an even smaller base image than the Python free 8 slim version </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=669">that you're using. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=670">That's true, it's only six megabytes or less than six megabytes. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=674">So that's what I did. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=675">I once again changed my Docker file that's built from this other base image instead. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=681">Tried to build it, but unfortunately that errored out. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=685">Command error with X, it said this one Python set of the pyeg info, check the logs. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=691">So I started comparing the log of these two Docker builds. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=695">And the first line that looked different was this downloading matplotlib line. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=701">On the top, we have the line from the Python free 8 base image and the bottom we have it </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=707">from the Python free 8 Alpine image. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=710">And the main thing that we see different is that in the top here, we see a wheel being </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=714">downloaded where in the bottom here, we see a title GC download. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=719">And that seems to be the main difference. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=722">And sort of the conclusion here is that PyPI wheels are not compatible with Alpine for </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=728">some reason. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=731">So what is a wheel and why aren't they compatible? </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=733">A wheel is essentially the reason why most Python packaging just works nowadays. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=738">When you do a pip install pandas or scikit-learn, it will just download something and there's </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=743">not a lot of dependencies that you need to have pre-installed on your PC. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=746">And that's because wheels are a binary distribution format in which all external C code is already </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=755">built for you. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=758">Rather than a so-called source distribution, which is the title GC thing, in which the </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=762">C code is not pre-built and actually needs to be compiled on your PC when you install </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=767">the package. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=769">You can see, for example, for pandas, the difference between a source disk build and </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=773">a wheel disk on the right. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=775">In the source disk build, we see algos.c and algos.pxd and algos.pyx, which are the C-Python </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=785">and original C codes. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=788">Whereas on the right, we see this C-Python, FreeCyphon and Darwin.so, the shared object, </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=794">which is essentially the compiled C code in the wheel distribution for us already. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=801">Again, on Alpine, it essentially downloads the left side, whereas on our previous one, </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=806">it downloaded on Python 3.8, it downloaded the right side's distribution. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=811">So why are those two things incompatible? </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=815">That turns out because Alpine wants to be so small, they use a slightly different set </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=823">of base packages than, for example, Debian does. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=827">This whole wheel thing is brilliant, but there's a lot of work in the background that needed </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=831">to happen to make this possible. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=833">And essentially, all Linux distributions are slightly different from each other. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=837">So what the original PEP writers thought of when they came up with the wheel PEP was to </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=842">make a standard subset of kernel plus user space APIs. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=847">They could assume to work on many different types of Linux installations, and they called </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=852">this standard manyLinux. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=854">Part of this standard is that things need to be built against glibc standard library, </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=859">whereas Alpine doesn't use glibc as the C library implementation, but uses Muzl. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=864">So all normal manyLinux wheels that work on Debian and Ubuntu and what have you don't </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=870">work on Alpine. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=871">So we kind of have to compile the code on our Alpine distribution to make them work. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=878">That means adding a lot of dependencies, build-based, free type dev, libpng dev for Matplotlib, </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=884">open blast dev for NumPy and SciPy and stuff. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=888">So let's add all of those to our Dockerfile, install again, do a build, takes about an </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=893">hour and it results in a bigger image. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=897">That's a bit of a shame. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=900">Makes sense though. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=901">We needed all these build dependencies that we didn't have in our previous Python 3.8 </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=907">image. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=908">So we should probably try to get rid of them. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=913">Now we already saw why this doesn't work, why we can't run this APK delete of our build </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=920">deps somewhere later on, because that's not how the Docker layering works. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=926">But we also don't want to squash all these layers together, because with these kinds </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=929">of build times, like these hour-long build times, we really like to use this Docker layer </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=935">caching and make the most use out of it so that our iteration speed is at least somewhat </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=941">decent. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=943">What we can do instead is use this thing called multistage builds. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=948">Multistage builds essentially allow you to have multiple from statements in a single </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=951">Dockerfile and you can copy stuff from an earlier Docker container build in the same </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=956">file to a later Docker image. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=960">So we make a builder stage here in the top, we make a runner stage here in the bottom. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=965">And essentially what we do in the runner stage is we download from the builder all the installed </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=970">packages and all the therefore compiled code as well. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=974">We still need open blast and freetype because those are runtime dependencies. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=979">So we add those to the runner image as well. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=983">That saves a good chunk of size. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=986">But then the last question is kind of, okay, why did we still need open blast and freetype? </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=993">Because our wheel has the precompiled code that runs in the runner image, so why is that </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=998">still necessary? </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1000">And open blast and freetype, by the way, add like 200 plus megabytes to this image. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1007">So what makes the wheels that we downloaded from PyPI different than the wheels that we </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1012">just build ourself in the builder image? </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1016">That has to do with that they're still linked against available dependencies on the operating </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1023">systems dynamically, that those dependencies aren't part of the wheel yet. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1030">And we can check this using a tool called audit wheel. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1033">So audit wheel is a tool that can check whether wheels are built correctly, whether they're </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1039">self-contained, but they can also nicely fix wheels and make sure that they don't need </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1044">any external dependencies. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1047">So this is, for example, a wheel that I built myself for NumPy. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1050">I ran audit wheel against it and it says, sure, this looks good, but there's still external </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1055">shared libraries required by the wheel. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1057">If we would do this from Appleclip, we would see open blast and freetype in there. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1063">But as I said, we can also use audit wheel to repair wheels. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1067">So if I ask audit wheel to repair the NumPy wheel, it will essentially look in the operating </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1074">system and see, okay, which dependencies, external dependencies did we rely on? </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1079">And let's copy those into the wheel instead. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1083">If we add that to, so if we add audit wheel and all those dependencies to our Docker file, </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1089">install the, or fix the wheels, then copy the fixed wheels to our runner image and run </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1098">our tests. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1099">We see that we got this container image down to 288 megabytes. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1106">At this point, most of the size comes from our site packages folder. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1109">That's good. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1110">197 megabytes out of the total, 230 something, 280 something. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1117">But considering we can probably do even better because we're compiling all the source code </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1122">anyway, we can ask the C compiler, well, get rid of all kinds of debug information and </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1127">optimize for disk space for site by that saves about 10 megabytes. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1131">We can add these compiler flags to our pip wheel statements that saves about 50 megabytes. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1140">Then there's one last thing, which we can link some of the system dependencies, these </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1144">is all files together using sim links. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1147">And that saves another 50 megabytes. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1150">We really shouldn't do this though. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1151">This is not norm core anymore. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1153">This is not part for a norm conf conference anymore. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1157">We should probably just stick with Python 3.8 slim and do the decent thing and get Docker </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1162">images that install in five minutes rather than an hour. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1166">That's it. </a><a href="https://www.youtube.com/watch?v=kx-SeGbkNPU&t=1167">Thanks for watching. </a>
      </p>
    </div>
  </section>
  </body>
</html>